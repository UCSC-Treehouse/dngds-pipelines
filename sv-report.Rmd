---
title: Structural Variation Report
author: UPD-UCSC
header-includes:
- \usepackage{booktabs}
- \usepackage{makecell}
urlcolor: teal
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.width=10)
```

```{r setup}
## Read input arguments
## 1: config file in YAML
## 2: filename for the output TSV
args = commandArgs(TRUE)

## Load packages
library(sveval)
library(VariantAnnotation)
library(GenomicRanges)
library(knitr)
library(kableExtra)
library(DT)
library(dplyr)
library(ggplot2)

## Reciproal overlap
rOverlap <- function(qgr, sgr){
  findOverlaps(qgr, sgr) %>% as.data.frame %>%
    mutate(qw=width(qgr)[queryHits], sw=width(sgr)[subjectHits],
           qsw=width(pintersect(qgr[queryHits], sgr[subjectHits])),
           rol=ifelse(qw>sw, qsw/qw, qsw/sw))
}

## Winsorize function
winsor <- function(x, u){
  if(any(x>u)) x[x>u] = u
  x
}

## Format links for genes (NCBI), genomic position (UCSC Genome Browser), or pli (gnomAD)
formatLink <- function(labels, urls, format='pdf'){
  if(format=='html'){
    return(paste0('[', labels, '](', urls,')'))
  }
  if(format=='rawhtml'){
    return(paste0('<a href="', urls, '" target="_blank">', labels, '</a>'))
  }
  if(format=='pdf'){
    return(paste0('{\\href{', urls, '}{', labels, '}}'))
  }
}
linkGenes <- function(genes, format='html'){
  urls = paste0('https://www.ncbi.nlm.nih.gov/gene?term=(', genes, '%5BGene%20Name%5D)%20AND%20Human%5BOrganism%5D')
  return(formatLink(genes, urls, format=format))
}
linkPli <- function(scores, genes, digits=3, format='html'){
  urls = paste0('https://gnomad.broadinstitute.org/gene/', genes)
  labels = round(scores, digits)
  return(formatLink(labels, urls, format=format))
}
linkPos <- function(chr, pos, type, size, flanks=500, format='html'){
  size = ifelse(type %in% c('DEL','DUP','INV'), size, 1)
  urls = paste0('https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg38&position=', chr, '%3A',
                pos-flanks, '-', pos+size+flanks, '&highlight=hg38.', chr, '%3A',
                pos, '-', pos+size, '%23E18F99')
  labels = paste0(chr, ':', pos)
  return(formatLink(labels, urls, format=format))
}

## Format some fields of a data.frame to convert them into links to external resources
formatTable <- function(df){
  if(nrow(df)==0) return(df)
  if('type' %in% colnames(df)){
    df$type = factor(df$type)
  }
  if('gt' %in% colnames(df)){
    df$gt = factor(df$gt)
  }
  if('pos' %in% colnames(df)){
    df$pos = linkPos(df$chr, df$pos, df$type, df$size, format='rawhtml')
    df$chr = NULL
  }
  if('gene' %in% colnames(df)){
    if('pLI' %in% colnames(df)){
      df$pLI = linkPli(df$pLI, df$gene, format='rawhtml')
    }
    df$gene = linkGenes(df$gene, format='rawhtml')
  }
  df
}

## Read config file
cfg.r = scan(args[1], '', sep='\n', quiet=TRUE)
cfg.r = strsplit(cfg.r, ': ')
cfg = gsub('"', '', unlist(lapply(cfg.r, '[', 2)))
names(cfg) = unlist(lapply(cfg.r, '[', 1))

## for debug:
cfg = c(sniffles_vcf='na12878.sniffles.vcf', svim_vcf='na12878.svim.vcf',
        idxcov='indexcov_na12878-indexcov.bed.gz', gene_pos='gene_position_info.tsv',
        pli_gene='gnomad.v2.1.1.lof_metrics.by_gene.txt.bgz',
        simprep='simpleRepeat.txt.gz',
        hsvlr='hsvlr.vcf.gz',
        dgv='GRCh38_hg38_variants_2016-08-31.txt',
        clingen='iscaPathogenic.txt.gz',
        ctcf='ENCFF010WHH.bed.gz',
        gnomadsv='gnomad_v2_sv.sites.pass.lifted.vcf.gz',
        cre='ENCFF166QIT.lifted.bed.gz',
        cons='phastConsElements100way.txt.gz',
        gencode='gencode.v35.annotation.gtf.gz',
        cytoband='cytoBandIdeo.txt.gz')

message('Read VCFs...')
svs.gr.l = list()
if('sniffles_vcf' %in% names(cfg)){
  svs.gr.l$sniffles = readSVvcf(cfg['sniffles_vcf'])
  svs.gr.l$sniffles$method = 'Sniffles'
}
if('svim_vcf' %in% names(cfg)){
  svs.gr.l$svim = readSVvcf(cfg['svim_vcf'])
  svs.gr.l$svim$method = 'SVIM'
}
if('cnv_ill' %in% names(cfg)){
  svs.gr.l$freec = readSVvcf(cfg['cnv_ill'])
  svs.gr.l$freec$method = 'Control-FREEC'
}
if('smoove_ill' %in% names(cfg)){
  svs.gr.l$smoove = readSVvcf(cfg['smoove_ill'])
  svs.gr.l$smoove$method = 'Smoove'
}

message('Combine variants...')
svs.gr = Reduce(c, svs.gr.l)
svs.gr = subset(svs.gr, ac>0)

message('Annotate overlap between methods...')
ol.gr = svOverlap(svs.gr, svs.gr, min.ol=.5, max.ins.dist=100)
ol.df = ol.gr %>% as.data.frame %>%
  mutate(method=svs.gr$method[subjectHits]) %>%
  group_by(queryHits) %>%
  summarize(nb.meths=length(unique(method)),
            meths=paste(sort(unique(method)), collapse=' '))
svs.gr$nb.meths = 1
svs.gr$nb.meths[ol.df$queryHits] = ol.df$nb.meths
svs.gr$meths = svs.gr$method
svs.gr$meths[ol.df$queryHits] = ol.df$meths

message('Annotate frequency using gnomAD...')
gnomad = readSVvcf(cfg['gnomadsv'], other.field='AF')
gnomad$ac = 1
ol.df = svOverlap(svs.gr, gnomad, min.ol=.1, max.ins.dist=100) %>% as.data.frame %>%
  mutate(freq=gnomad$AF[subjectHits]) %>%
  group_by(queryHits) %>%
  summarize(freq=max(freq))
svs.gr$freq = 0
svs.gr$freq[ol.df$queryHits] = ol.df$freq

message('Gene annotation...')
types.ranked = c('CDS', 'UTR', 'promoter', 'gene')
types.labels = c('coding', 'UTR', 'promoter', 'intronic')
genc = rtracklayer::import(cfg['gencode'])
genc = subset(genc, type %in% types.ranked)
prom = promoters(subset(genc, type=='gene'))
prom$type = 'promoter'
genc = c(genc, prom)

ol.genc = findOverlaps(svs.gr, genc) %>% as.data.frame %>%
  mutate(gene=genc$gene_name[subjectHits],
         gene_type=genc$gene_type[subjectHits],
         type=genc$type[subjectHits],
         type=factor(type, levels=types.ranked, labels=types.labels)) %>%
  arrange(type) %>% 
  group_by(queryHits, gene, gene_type) %>%
  summarize(impact=head(type, 1))

ol.genc.sum = ol.genc %>% group_by(queryHits) %>%
  summarize(genes=ifelse(n()>10,
                         paste(n(), 'genes'),
                         paste0(gene, '(', impact, '>', gene_type, ')', collapse=' ')),
            nb.pc.genes=sum(gene_type=='protein_coding'))
svs.gr$genes = NA
svs.gr$genes[ol.genc.sum$queryHits] = ol.genc.sum$genes
svs.gr$nb.pc.genes = 0
svs.gr$nb.pc.genes[ol.genc.sum$queryHits] = ol.genc.sum$nb.pc.genes

## Nearby protein-coding genes
pc.genes = subset(genc, type=='gene' & gene_type=='protein_coding')
d.df = distanceToNearest(svs.gr, pc.genes) %>% as.data.frame
svs.gr$gene.dist = NA
svs.gr$gene.dist[d.df$queryHits] = d.df$distance
svs.gr$gene.near = NA
svs.gr$gene.near[d.df$queryHits] = pc.genes$gene_name[d.df$subjectHits]

message('Import genes of interest...')
genes = read.table(cfg['gene_pos'], as.is=TRUE, header=TRUE) %>%
  dplyr::rename(gene=gene_name) %>%
  mutate(gene_list=factor(gene_list))
genes.list = genes %>% select(gene, gene_list) %>% unique
genes.gr = makeGRangesFromDataFrame(genes, keep.extra.columns=TRUE)

d.df = distanceToNearest(svs.gr, genes.gr) %>% as.data.frame
svs.gr$sel.gene.dist = NA
svs.gr$sel.gene.dist[d.df$queryHits] = d.df$distance
svs.gr$sel.gene.near = NA
svs.gr$sel.gene.near[d.df$queryHits] = genes.gr$gene[d.df$subjectHits]

message('Import pli scores...')
pli.df = read.table(cfg['pli_gene'], as.is=TRUE, header=TRUE, sep='\t')
pli.df = pli.df %>% select(gene, pLI) %>% unique

message('Overlap with simple repeats...')
sr = read.table(cfg['simprep'])
sr = sr[,c(2,3,4,6,7,17)]
colnames(sr) = c('chrom', 'start', 'end', 'period', 'copyNum', 'sequence')
sr = makeGRangesFromDataFrame(sr, keep.extra.columns=TRUE)
svs.gr$simp.rep = overlapsAny(svs.gr, sr, maxgap=10)

message('Overlap with SVs from public long-read studies...')
lr.gr = readSVvcf(cfg['hsvlr'])
lr.gr$ac = 1
ol.gr = svOverlap(svs.gr, lr.gr, min.ol=.5, max.ins.dist=100)
svs.gr$hsvlr = FALSE
svs.gr$hsvlr[ol.gr$queryHits] = TRUE

message('Overlap with DGV catalog...')
dgv = read.table(cfg['dgv'], as.is=TRUE, header=TRUE, sep='\t')
dgv = dgv[,c('chr','start','end', 'variantsubtype')]
dgv$chr = paste0('chr', dgv$chr)
dgv = makeGRangesFromDataFrame(dgv, keep.extra.columns=TRUE)
dgv.loss = subset(dgv, variantsubtype %in% c('loss', 'deletion', 'gain+loss'))
dgv.loss = overlapsAny(svs.gr, dgv.loss, maxgap=10)
dgv.gain = subset(dgv, variantsubtype %in% c('duplication', 'gain', 'insertion',
                                             'mobile element insertion',
                                             'novel sequence insertion',
                                             'tandem duplication', 'gain+loss'))
dgv.gain = overlapsAny(svs.gr, dgv.gain, maxgap=10)
svs.gr$dgv = 'none'
svs.gr$dgv = ifelse(dgv.loss, 'loss', svs.gr$dgv)
svs.gr$dgv = ifelse(dgv.gain, 'gain', svs.gr$dgv)
svs.gr$dgv = ifelse(dgv.gain & dgv.loss, 'loss+gain', svs.gr$dgv)

message('Overlap with ClinGenn pathogenic CNVs...')
clingen = read.table(cfg['clingen'], as.is=TRUE, sep='\t')
clingen = GRanges(clingen$V2, IRanges(clingen$V3, clingen$V4))
ol.o = rOverlap(svs.gr, clingen)
svs.gr$clingen = FALSE
svs.gr$clingen[subset(ol.o, rol>.5)$queryHits] = TRUE

message('Overlap with CTCF peaks...')
ctcf = read.table(cfg['ctcf'], as.is=TRUE)
ctcf = with(ctcf, GRanges(V1, IRanges(V2, V3), score=V5))
svs.gr$ctcf = overlapsAny(svs.gr, ctcf)

message('Overlap with regulatory regions...')
cres = read.table(cfg['cre'], as.is=TRUE)
cres = with(cres, GRanges(V1, IRanges(V2, V3), score=V5))
svs.gr$cres = overlapsAny(svs.gr, cres)

message('Overlap with conserved regions...')
cons.gr = read.table(cfg['cons'], as.is=TRUE)
cons.gr = with(cons.gr, GRanges(V2, IRanges(V3, V4)))
svs.gr$cons = overlapsAny(svs.gr, cons.gr)

## clean up some memory
rm(cons.gr, cres, ctcf, clingen, dgv, lr.gr, sr, gnomad)
gc()

## Gene-level info
svs.gene = svs.gr[ol.genc$queryHits]
svs.gene$genes = NULL
svs.gene$gene = ol.genc$gene
svs.gene$gene_type = ol.genc$gene_type
svs.gene$impact = ol.genc$impact
```

# {.tabset}

## Methods

The structural variants found by [Sniffles](https://github.com/fritzsedlazeck/Sniffles) and [SVIM](https://github.com/eldariont/svim) were annotated by [SnpEff](http://snpeff.sourceforge.net/) and with the frequency of variants in the [gnoma-SV catalog](https://macarthurlab.org/2019/03/20/structural-variants-in-gnomad/).
To focus on high-confidence SV calls, we only look at calls made by both Sniffles and SVIM.

The variants' "effects" in this report come from SnpEff and follow the format [described in SnpEff documentation](http://snpeff.sourceforge.net/SnpEff_manual.html#eff).

The *pLI* score was computed by the [gnomAD project](https://gnomad.broadinstitute.org/).
It represents the probability that the gene is intolerant to loss-of-function variants.
A variant affecting a gene with a high pLI score (e.g. >0.9) is more likely to have a biological impact.
The variants in each section are ordered to show those affecting genes with the highest pLI first.

In the following, we also removed common variants, i.e. either:

- frequency higher than 1% in gnomAD-SV
- seen in the SV catalog from long-read studies

Clarifications about some column names:

- `pli` prob of  loss-of-function intolerance described above.
- `type` SV type
- `gt` genotype, usually `0/1` for het or `1/1` for hom.
- `freq` allele frequency of similar SV in gnomAD-SV (>10K genomes sequenced with Illumina whole-genome sequencing).
- `dgv` does the variant overlap any variant in DGV in any way?
- `clingen` any similar ClinGen pathogenic variants (as found at the UCSC Genome Browser)? "Similar" defined as reciprocal overlap > 50%.
- `ctcf` does the variant overlap a CTCF binding site? From ENCODE track for kidney.
- `cres` does the variant overlap a regulatory region? From ENCODE track for kidney.
- `simp.rep` is the variant in or close to a simple repeat (see simple repeat track in the UCSC Genome Browser).
- `hsvlr` any similar variant in SV catalogs from public long-read sequencing studies?
- `cons` does the variant overlap a conserved element (as defined by 100 vertebrate phastCons track)
- `impact` potential impact based on gene annotation: 'coding', 'UTR', 'promoter', 'intronic'.
- `distance` distance to the gene boundaries.
- `nb.pc.genes` number of protein-coding genes overlapped by the variant.

## Genes of interest

There are `r length(unique(genes$gene))` genes in `r length(unique(genes$gene_list))` gene lists:

```{r genes}
genes %>% group_by(gene_list) %>% summarize(genes=n()) %>% kable
```

---

They contain the following genes:

```{r genes2}
genes %>% formatTable %>% datatable(filter='top', escape=FALSE, options=list(pageLength=50))
```

## Coding/UTR/promoter variants in protein-coding genes

```{r table_high_gene}
svs.gene %>% as.data.frame %>% mutate(chr=seqnames, pos=start) %>%
  filter(nb.meths>1, gene_type=='protein_coding',
         freq<.01, !hsvlr, impact %in% c('coding', 'UTR', 'promoter')) %>%
  merge(pli.df, all.x=TRUE) %>%
  merge(genes.list, all.x=TRUE) %>% 
  select(gene, impact, pLI, gene_list,
         pos, type, size, ac, freq,
         simp.rep, dgv, cons, cres,
         method, nb.meths, meths, chr) %>%
  arrange(is.na(gene_list), impact, desc(pLI), freq, desc(size)) %>%
  formatTable() %>%
  datatable(filter='top', escape=FALSE, options=list(pageLength=50))
```

## Intronic variants in protein-coding genes

```{r table_intronic}
svs.gene %>% as.data.frame %>% mutate(chr=seqnames, pos=start) %>%
  filter(nb.meths>1, gene_type=='protein_coding',
         freq<.01, !hsvlr, impact == 'intronic') %>%
  merge(pli.df, all.x=TRUE) %>%
  merge(genes.list, all.x=TRUE) %>% 
  select(gene, impact, pLI, gene_list,
         pos, type, size, ac, freq,
         simp.rep, dgv, cons, cres,
         method, nb.meths, meths, chr) %>%
  arrange(is.na(gene_list), impact, desc(pLI), freq, desc(size)) %>%
  formatTable() %>%
  datatable(filter='top', escape=FALSE, options=list(pageLength=50))
```

## Rare variants near genes of interest

```{r table_rare_near_sel}
svs.gr %>% as.data.frame %>% mutate(chr=seqnames, pos=start) %>%
  filter(nb.meths>1, sel.gene.dist>0, sel.gene.dist<1e5, freq<.01) %>%
  select(sel.gene.dist, sel.gene.near, 
         pos, type, size, ac, freq, genes,
         simp.rep, dgv, cons, cres, ctcf,
         method, nb.meths, meths, chr) %>%
  arrange(sel.gene.dist, freq) %>%
  formatTable() %>%
  datatable(filter='top', escape=FALSE, options=list(pageLength=50))
```

## Non-coding variants in conserved or regulatory regions

```{r table_noncoding}
svs.gr %>% as.data.frame %>% mutate(chr=seqnames, pos=start) %>%
  filter(nb.meths>1, freq<.01, !hsvlr, cres | cons | ctcf,
         !grepl('protein_coding', genes)) %>%
  select(pos, type, size, ac, freq, genes,
         cons, cres, ctcf,
         gene.dist, gene.near,
         simp.rep, dgv, 
         method, nb.meths, meths, chr) %>%
  arrange(freq, gene.dist, !cons, !cres, desc(size)) %>%
  formatTable() %>%
  datatable(filter='top', escape=FALSE, options=list(pageLength=50))
```

## Large

Large and rare variants tend to have a higher biological impact.
Interesting profiles to look for:

- large deletions spanning a CTCF binding region (could lead to TAD reorganization and ectopic gene expression).
- Overlap with pathogenic CNV in the ClinGen database. *clingen* column shows variants with 50% reciprocal overlap with a pathogenic CNV.
- Large SV affecting multiple protein-coding genes.

```{r rarelarge}
svs.gr %>% as.data.frame %>% mutate(chr=seqnames, pos=start) %>%
  filter(size>1e3, freq<.01, !hsvlr, nb.meths>1) %>%
  select(pos, type, size, ac, freq, 
         nb.pc.genes, genes,
         clingen, cons, cres, ctcf,
         simp.rep, dgv, 
         method, nb.meths, meths, chr) %>%
  arrange(!clingen, desc(nb.pc.genes), desc(abs(size))) %>%
  formatTable %>%
  datatable(filter='top', escape=FALSE, options=list(pageLength=50))
```


```{r writetsv}
## remove duplicates, inc. when differring only with effect (second being NA)
svs.gr
svs.gene

svs.all = subset(svs.gr, is.na(genes))
svs.all$genes = NULL
svs.all$gene = svs.all$gene_type = svs.all$impact = NA
svs.all = c(svs.gene, svs.all)

## write TSV
out.tsv = svs.all %>% as.data.frame %>% unique
write.table(out.tsv, file='svs-annotated.tsv', sep='\t', row.names=FALSE, quote=FALSE)
```

## Chromosomal aberrations

Of note, the p arms of chromosomes 13, 14, 15, and 22 are not assembled. 
So is the last chunk of chrYq.
It's expected to see no coverage in these regions.

```{r idxcov, fig.height=10}
if('idxcov' %in% cfg){
  cov.df = read.table(cfg['idxcov'], as.is=TRUE, header=TRUE, sep='\t', comment='')
  colnames(cov.df) = c('chr', 'start', 'end', 'cov')
  
  chrs.order = c(1:22, 'X','Y','M')
  if(all(grepl('chr', unique(cov.df$chr)))){
    chrs.order = paste0('chr', chrs.order)
  }
  cov.df = cov.df %>% mutate(chr=factor(chr, levels=chrs.order))
  
  cov.df = cov.df %>%
    filter(chr!='chrM') %>% 
    arrange(chr, start) %>%
    group_by(chr) %>% mutate(bin=head(rep(1:(n()/10+1), each=50), n())) %>%
    group_by(chr, bin) %>% summarize(start=min(start), end=max(end), cov=sum(cov)) %>%
    ungroup %>% mutate(cov=cov/median(cov))

  ## Arm and centromere
  cyto.df = read.table(cfg['cytoband'], as.is=TRUE, sep='\t')
  colnames(cyto.df) = c('chr', 'start', 'end', 'band', 'gieaStain')
  cyto.df = cyto.df %>% mutate(arm=substr(band, 1, 1)) %>%
    filter(arm %in% c('p', 'q')) %>% 
    group_by(chr, arm) %>% summarize(start=min(start), end=max(end))
  cyto.gr = makeGRangesFromDataFrame(cyto.df, keep.extra.columns=TRUE)

  cov.gr = makeGRangesFromDataFrame(cov.df)
  cov.df$arm = 'other'
  cov.df$arm[overlapsAny(cov.gr, subset(cyto.gr, arm=='p'))] = 'p'
  cov.df$arm[overlapsAny(cov.gr, subset(cyto.gr, arm=='q'))] = 'q'
  
  ggp = ggplot(cov.df, aes(x=start/1e6, y=winsor(cov, 2))) +
    geom_point(aes(color=arm), alpha=.5) + theme_bw() +
    geom_hline(yintercept=1, linetype=2) + 
    geom_smooth(se=FALSE) +
    facet_wrap(~chr, scales='free') +
    ylab('normalized coverage') +
    xlab('position (Mbp)') +
    ylim(0,2) +
    scale_colour_brewer(palette='Set1')
    
  print(ggp)

  cov.df %>% group_by(chr, arm) %>% summarize(median.cov=median(cov)) %>%
    arrange(desc(abs(1-median.cov))) %>% kable
}
```
